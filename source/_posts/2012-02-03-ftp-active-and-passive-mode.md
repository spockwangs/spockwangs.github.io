---
layout: post
title: FTP的主动和被动模式
comments: true
categories:
- computer network
---

FTP是仅基于TCP的服务，不支持UDP。与众不同的是FTP使用2个端口，一个数据端口和
一个命令端口（也可叫做控制端口）。通常来说这两个端口是21（命令端口）和20（数
据端口）。但FTP工作方式的不同，数据端口并不总是20。这就是主动与被动FTP的最大
不同之处。
<!--more-->

## 主动FTP

主动方式的FTP是这样的：客户端从一个任意的非特权端口N（N > 1024）连接到FTP服
务器的命令端口，也就是21端口。然后客户端开始监听端口N+1，并发送FTP命令“PORT
N+1”到FTP服务器。接着服务器会从它自己的数据端口（20）连接到客户端指定的数据
端口（N+1）。

针对FTP服务器前面的防火墙来说，必须允许以下通讯才能支持主动方式FTP：

1.  任何大于1024的端口到FTP服务器的21端口。（客户端初始化的连接）；
2.  FTP服务器的21端口到大于1024的端口。 （服务器响应客户端的控制端口）；
3.  FTP服务器的20端口到大于1024的端口。（服务器端初始化数据连接到客户端的数据端口）；
4.  大于1024的端口到FTP服务器的20端口（客户端发送ACK响应到服务器的数据端口）。

## 被动FTP

为了解决服务器发起到客户的连接的问题，人们开发了一种不同的FTP连接方式。这就
是所谓的被动方式，或者叫做PASSIVE，当客户端通知服务器它处于被动模式时才启用。
在被动方式FTP中，命令连接和数据连接都由客户端发起，这样就可以解决从服务器到
客户端的数据端口的入方向连接被防火墙过滤掉的问题。当开启一个FTP连接时，客户
端打开两个任意的非特权本地端口（N > 1024和N+1）。第一个端口连接服务器的
21端口，但与主动方式的FTP不同，客户端不会提交PORT命令并允许服务器来回连它的
数据端口，而是提交PASV命令。这样做的结果是服务器会开启一个任意的非特权端口
（P > 1024），并发送PORT P命令给

客户端。然后客户端发起从本地端口N+1到服务器的端口P的连接用来传送数据。对于服务器端的防火墙来说，必须允许下面的通讯才能支持被动方式的FTP:

1.  从任何大于1024的端口到服务器的21端口（客户端初始化的连接） ；
2.  服务器的21 端口到任何大于1024的端口（服务器响应到客户端的控制端口的连接） ；
3.  从任何大于1024端口到服务器的大于1024端口（客户端初始化数据连接到服务器指定的任意端口）；
4.  服务器的大于1024端口到远程的大于1024的端口（服务器发送ACK响应和数据到客户端的数据端口）。

以上关于主动和被动FTP的解释，可以简单概括为以下两点：

1.  主动FTP:<br>
    命令连接：客户端 > 1024端口 -> 服务器 21端口<br />
	数据连接：客户端 > 1024端口 -> 服务器 20端口
2.  被动FTP：<br />
    命令连接：客户端 &gt;1024端口 -&gt; 服务器 21端口<br />
	数据连接：客户端 &gt;1024端口 -&gt; 服务器 > 1024端口

## 主动与被动FTP优缺点

主动FTP对FTP服务器的管理有利，但对客户端的管理不利。因为 FTP服务器企图与客户
端的高位随机端口建立连接，而这个端口很有可能被客户端的防火墙阻塞掉。被动FTP
对FTP客户端的管理有利，但对服务器端的管理不利。因为客户端要与服务器端建立两
个连接，其中一个连到一个高位随机端口，而这个端口很有可能被服务器端的防火墙阻
塞掉。
